package edu.vision.se;

import static org.junit.Assert.assertThrows;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;
import java.util.zip.ZipOutputStream;

import org.junit.Test;
import org.junit.function.ThrowingRunnable;

import io.github.pixee.security.ZipSecurity;

public class Testcase1 {
    @Test
    public void it_prevents_sister_directory_escape() throws IOException {
        String currentDir = new File("").getCanonicalFile().getName();
        ZipEntry entry = new ZipEntry("foo/../../" + currentDir + "-other-sister-dir");
        InputStream is = createZipFrom(entry);

        ZipInputStream hardenedStream = ZipSecurity.createHardenedInputStream(is);
        // assertThrows(SecurityException.class, hardenedStream::getNextEntry);
        validateReturnValue(hardenedStream::getNextEntry);
    }

    public void validateReturnValue(ThrowingRunnable runnable) {
        assertThrows(SecurityException.class, runnable);
    }

    private InputStream createZipFrom(final ZipEntry entry) throws IOException {
        ByteArrayOutputStream os = new ByteArrayOutputStream();
        ZipOutputStream zos = new ZipOutputStream(os);
        zos.putNextEntry(entry);
        zos.closeEntry();
        zos.close();
        return new ByteArrayInputStream(os.toByteArray());
    }
}