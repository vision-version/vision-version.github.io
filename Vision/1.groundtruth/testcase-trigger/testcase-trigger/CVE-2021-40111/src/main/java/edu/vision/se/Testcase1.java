package edu.vision.se;

import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.util.Base64;

import org.apache.james.imap.api.Tag;
import org.apache.james.imap.decode.DecodingException;
import org.apache.james.imap.decode.ImapRequestStreamLineReader;
import org.apache.james.imap.decode.parser.StatusCommandParser;
import org.apache.james.imap.encode.FakeImapSession;
import org.apache.james.imap.message.response.UnpooledStatusResponseFactory;
import org.junit.Test;

public class Testcase1 {
    @Test(timeout = 1000)
    public void fuzzingInputShouldNotLeadToOutOfMemoryException() {
        String base64Input = "MiAgKH8MSU4kQiBOJEIgICMAf15Df39/f39/f39/f39/f39/f39/f39/f0NDRTogP19GbT8JCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCT0NAAAAAAAAAD0/TkNPAAAAAAhlAAAAAAA=";
        byte[] bytes = Base64.getDecoder().decode(base64Input);

        assertThatThrownBy(() -> new StatusCommandParserChild(new UnpooledStatusResponseFactory())
                .decode(new ImapRequestStreamLineReader(new ByteArrayInputStream(bytes),
                        new ByteArrayOutputStream()), new Tag("AEA"), new FakeImapSession()))
                .isInstanceOf(DecodingException.class);
    }
}

class StatusCommandParserChild extends StatusCommandParser {
    public StatusCommandParserChild(UnpooledStatusResponseFactory statusResponseFactory) {
        super(statusResponseFactory);
    }

    public void decode(ImapRequestStreamLineReader request, Tag tag, FakeImapSession session) throws DecodingException {
        super.decode(request, tag, session);
    }
}