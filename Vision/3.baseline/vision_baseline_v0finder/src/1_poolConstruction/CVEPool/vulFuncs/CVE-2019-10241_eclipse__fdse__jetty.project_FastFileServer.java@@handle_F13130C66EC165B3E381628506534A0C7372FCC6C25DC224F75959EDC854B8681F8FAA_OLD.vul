finalintsmall=response.getbuffersize();finalintmedium=8*small;finalfilefile=newfile(this.dir,request.getpathinfo());if(!file.exists())return;baserequest.sethandled(true);if(file.isdirectory())if(!request.getpathinfo().endswith(uriutil.slash))response.sendredirect(response.encoderedirecturl(uriutil.addpaths(request.getrequesturi(),uriutil.slash)));return;stringlisting=resource.newresource(file).getlisthtml(request.getrequesturi(),request.getpathinfo().lastindexof("/")>0);response.setcontenttype("text/html;charset=utf-8");response.getwriter().println(listing);return;response.setdateheader("last-modified",file.lastmodified());response.setdateheader("content-length",file.length());response.setcontenttype(mimetypes.getmimebyextension(file.getname()));if(file.length()<small)((httpoutput)response.getoutputstream()).sendcontent(filechannel.open(file.topath(),standardopenoption.read));return;finalasynccontextasync=request.startasync();callbackcompletioncb=newcallback()@overridepublicvoidsucceeded()async.complete();@overridepublicvoidfailed(throwablex)x.printstacktrace();async.complete();;if(file.length()<medium)((httpoutput)response.getoutputstream()).sendcontent(filechannel.open(file.topath(),standardopenoption.read),completioncb);return;bytebufferbuffer;try(randomaccessfileraf=newrandomaccessfile(file,"r");)buffer=raf.getchannel().map(mapmode.read_only,0,raf.length());buffer=buffer.asreadonlybuffer();((httpoutput)response.getoutputstream()).sendcontent(buffer,completioncb);