finalcharsetencoderenc=newencoder();finalcharbuffercb=charbuffer.wrap(name);charbuffertmp=null;bytebufferout=bytebuffer.allocate(estimateinitialbuffersize(enc,cb.remaining()));while(cb.remaining()>0)finalcoderresultres=enc.encode(cb,out,false);if(res.isunmappable()||res.ismalformed())intspaceforsurrogate=estimateincrementalencodingsize(enc,6*res.length());if(spaceforsurrogate>out.remaining())intcharcount=0;for(inti=cb.position();i<cb.limit();i++)charcount+=!enc.canencode(cb.get(i))?6:1;inttotalextraspace=estimateincrementalencodingsize(enc,charcount);out=zipencodinghelper.growbufferby(out,totalextraspace-out.remaining());if(tmp==null)tmp=charbuffer.allocate(6);for(inti=0;i<res.length();++i)out=encodefully(enc,encodesurrogate(tmp,cb.get()),out);elseif(res.isoverflow())intincrement=estimateincrementalencodingsize(enc,cb.remaining());out=zipencodinghelper.growbufferby(out,increment);enc.encode(cb,out,true);out.limit(out.position());out.rewind();returnout;