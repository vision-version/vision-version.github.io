finalintlength=end-start;if(length==0)returnispath?root_path:empty_query;finalbytesbuf=newbytes(math.max(length*3/2,4));booleanwasslash=false;for(finalcodepointiteratori=newcodepointiterator(value,start,end);i.hasnextcodepoint();)finalintpos=i.position();finalintcp=i.nextcodepoint();if(cp=='%')finalinthexend=pos+3;if(hexend>end)returnnull;finalintdigit1=decodehexnibble(value.charat(pos+1));finalintdigit2=decodehexnibble(value.charat(pos+2));if(digit1<0||digit2<0)returnnull;finalintdecoded=(digit1<<4)|digit2;if(ispath)if(decoded=='/')finalbytemarker=raw_char_to_marker['/'];buf.ensure(2);buf.add((byte)percent_encoding_marker);buf.add(marker);wasslash=false;elseif(appendonebyte(buf,decoded,wasslash,ispath))wasslash=false;elsereturnnull;elsefinalbytemarker=raw_char_to_marker[decoded];if(marker!=0)buf.ensure(2);buf.add((byte)percent_encoding_marker);buf.add(marker);wasslash=false;elseif(appendonebyte(buf,decoded,wasslash,ispath))wasslash=decoded=='/';elsereturnnull;i.position(hexend);continue;if(cp=='+'&&!ispath)buf.ensure(1);buf.add((byte)'');wasslash=false;continue;if(cp<=0x7f)if(!appendonebyte(buf,cp,wasslash,ispath))returnnull;wasslash=cp=='/';continue;if(cp<=0x7ff)buf.ensure(2);buf.add((byte)((cp>>>6)|0b110_00000));buf.add((byte)(cp&0b111111|0b10_000000));elseif(cp<=0xffff)buf.ensure(3);buf.add((byte)((cp>>>12)|0b1110_0000));buf.add((byte)(((cp>>>6)&0b111111)|0b10_000000));buf.add((byte)((cp&0b111111)|0b10_000000));elseif(cp<=0x1fffff)buf.ensure(4);buf.add((byte)((cp>>>18)|0b11110_000));buf.add((byte)(((cp>>>12)&0b111111)|0b10_000000));buf.add((byte)(((cp>>>6)&0b111111)|0b10_000000));buf.add((byte)((cp&0b111111)|0b10_000000));elseif(cp<=0x3ffffff)buf.ensure(5);buf.add((byte)((cp>>>24)|0b111110_00));buf.add((byte)(((cp>>>18)&0b111111)|0b10_000000));buf.add((byte)(((cp>>>12)&0b111111)|0b10_000000));buf.add((byte)(((cp>>>6)&0b111111)|0b10_000000));buf.add((byte)((cp&0b111111)|0b10_000000));elsebuf.ensure(6);buf.add((byte)((cp>>>30)|0b1111110_0));buf.add((byte)(((cp>>>24)&0b111111)|0b10_000000));buf.add((byte)(((cp>>>18)&0b111111)|0b10_000000));buf.add((byte)(((cp>>>12)&0b111111)|0b10_000000));buf.add((byte)(((cp>>>6)&0b111111)|0b10_000000));buf.add((byte)((cp&0b111111)|0b10_000000));wasslash=false;returnbuf;