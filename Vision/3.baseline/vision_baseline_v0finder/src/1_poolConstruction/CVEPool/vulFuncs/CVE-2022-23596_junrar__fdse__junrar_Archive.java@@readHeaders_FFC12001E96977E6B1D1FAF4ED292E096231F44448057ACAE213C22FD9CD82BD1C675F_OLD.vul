this.markhead=null;this.newmhd=null;this.headers.clear();this.currentheaderindex=0;inttoread=0;finalset<long>processedpositions=newhashset<>();while(true)intsize=0;longnewpos=0;rawdataiorawdata=newrawdataio(channel);finalbyte[]baseblockbuffer=safelyallocate(baseblock.baseblocksize,max_header_size);if(newmhd!=null&&newmhd.isencrypted())byte[]salt=newbyte[8];rawdata.readfully(salt,8);tryciphercipher=rijndael.builddecipherer(password,salt);rawdata.setcipher(cipher);catch(exceptione)thrownewinitdeciphererfailedexception(e);finallongposition=this.channel.getposition();if(position>=filelength)break;size=rawdata.readfully(baseblockbuffer,baseblockbuffer.length);if(size==0)break;finalbaseblockblock=newbaseblock(baseblockbuffer);block.setpositioninfile(position);unrarheadertypeheadertype=block.getheadertype();if(headertype==null)logger.warn("unknownblockheader!");thrownewcorruptheaderexception();switch(headertype)casemarkheader:this.markhead=newmarkheader(block);if(!this.markhead.issignature())if(markhead.getversion()==rarversion.v5)logger.warn("supportforrarversion5isnotyetimplemented!");thrownewunsupportedrarv5exception();elsethrownewbadrararchiveexception();this.headers.add(this.markhead);break;casemainheader:toread=block.hasencryptversion()?mainheader.mainheadersizewithenc:mainheader.mainheadersize;finalbyte[]mainbuff=safelyallocate(toread,max_header_size);rawdata.readfully(mainbuff,mainbuff.length);finalmainheadermainhead=newmainheader(block,mainbuff);this.headers.add(mainhead);this.newmhd=mainhead;break;casesignheader:toread=signheader.signheadersize;finalbyte[]signbuff=safelyallocate(toread,max_header_size);rawdata.readfully(signbuff,signbuff.length);finalsignheadersignhead=newsignheader(block,signbuff);this.headers.add(signhead);break;caseavheader:toread=avheader.avheadersize;finalbyte[]avbuff=safelyallocate(toread,max_header_size);rawdata.readfully(avbuff,avbuff.length);finalavheaderavhead=newavheader(block,avbuff);this.headers.add(avhead);break;casecommheader:toread=commentheader.commentheadersize;finalbyte[]commbuff=safelyallocate(toread,max_header_size);rawdata.readfully(commbuff,commbuff.length);finalcommentheadercommhead=newcommentheader(block,commbuff);this.headers.add(commhead);newpos=commhead.getpositioninfile()+commhead.getheadersize(isencrypted());this.channel.setposition(newpos);if(processedpositions.contains(newpos))thrownewbadrararchiveexception();processedpositions.add(newpos);break;caseendarcheader:toread=0;if(block.hasarchivedatacrc())toread+=endarcheader.endarcarchivedatacrcsize;if(block.hasvolumenumber())toread+=endarcheader.endarcvolumenumbersize;endarcheaderendarchead;if(toread>0)finalbyte[]endarchbuff=safelyallocate(toread,max_header_size);rawdata.readfully(endarchbuff,endarchbuff.length);endarchead=newendarcheader(block,endarchbuff);elseendarchead=newendarcheader(block,null);this.headers.add(endarchead);return;default:finalbyte[]blockheaderbuffer=safelyallocate(blockheader.blockheadersize,max_header_size);rawdata.readfully(blockheaderbuffer,blockheaderbuffer.length);finalblockheaderblockhead=newblockheader(block,blockheaderbuffer);switch(blockhead.getheadertype())casenewsubheader:casefileheader:toread=blockhead.getheadersize(false)-blockheader.baseblocksize-blockheader.blockheadersize;finalbyte[]fileheaderbuffer=safelyallocate(toread,max_header_size);rawdata.readfully(fileheaderbuffer,fileheaderbuffer.length);finalfileheaderfh=newfileheader(blockhead,fileheaderbuffer);this.headers.add(fh);newpos=fh.getpositioninfile()+fh.getheadersize(isencrypted())+fh.getfullpacksize();this.channel.setposition(newpos);if(processedpositions.contains(newpos))thrownewbadrararchiveexception();processedpositions.add(newpos);break;caseprotectheader:toread=blockhead.getheadersize(false)-blockheader.baseblocksize-blockheader.blockheadersize;finalbyte[]protectheaderbuffer=safelyallocate(toread,max_header_size);rawdata.readfully(protectheaderbuffer,protectheaderbuffer.length);finalprotectheaderph=newprotectheader(blockhead,protectheaderbuffer);newpos=ph.getpositioninfile()+ph.getheadersize(isencrypted())+ph.getdatasize();this.channel.setposition(newpos);if(processedpositions.contains(newpos))thrownewbadrararchiveexception();processedpositions.add(newpos);break;casesubheader:finalbyte[]subheadbuffer=safelyallocate(subblockheader.subblockheadersize,max_header_size);rawdata.readfully(subheadbuffer,subheadbuffer.length);finalsubblockheadersubhead=newsubblockheader(blockhead,subheadbuffer);subhead.print();switch(subhead.getsubtype())casemac_head:finalbyte[]macheaderbuffer=safelyallocate(macinfoheader.macinfoheadersize,max_header_size);rawdata.readfully(macheaderbuffer,macheaderbuffer.length);finalmacinfoheadermacheader=newmacinfoheader(subhead,macheaderbuffer);macheader.print();this.headers.add(macheader);break;casebeea_head:break;caseea_head:finalbyte[]eaheaderbuffer=safelyallocate(eaheader.eaheadersize,max_header_size);rawdata.readfully(eaheaderbuffer,eaheaderbuffer.length);finaleaheadereaheader=neweaheader(subhead,eaheaderbuffer);eaheader.print();this.headers.add(eaheader);break;casentacl_head:break;casestream_head:break;caseuo_head:toread=subhead.getheadersize(false);toread-=baseblock.baseblocksize;toread-=blockheader.blockheadersize;toread-=subblockheader.subblockheadersize;finalbyte[]uoheaderbuffer=safelyallocate(toread,max_header_size);rawdata.readfully(uoheaderbuffer,uoheaderbuffer.length);finalunixownersheaderuoheader=newunixownersheader(subhead,uoheaderbuffer);uoheader.print();this.headers.add(uoheader);break;default:break;break;default:logger.warn("unknownheader");thrownewnotrararchiveexception();