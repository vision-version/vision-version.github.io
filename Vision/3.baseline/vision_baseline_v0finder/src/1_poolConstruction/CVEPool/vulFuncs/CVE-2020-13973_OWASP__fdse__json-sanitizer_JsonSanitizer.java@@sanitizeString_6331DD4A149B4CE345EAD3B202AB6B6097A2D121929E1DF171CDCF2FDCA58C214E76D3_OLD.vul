booleanclosed=false;for(inti=start;i<end;++i)charch=jsonish.charat(i);switch(ch)case'\n':replace(i,i+1,"\\n");break;case'\r':replace(i,i+1,"\\r");break;case'\u2028':replace(i,i+1,"\\u2028");break;case'\u2029':replace(i,i+1,"\\u2029");break;case'"':case'\'':if(i==start)if(ch=='\'')replace(i,i+1,'"');elseif(i+1==end)charstartdelim=jsonish.charat(start);if(startdelim!='\'')startdelim='"';closed=startdelim==ch;if(closed)if(ch=='\'')replace(i,i+1,'"');elseif(ch=='"')insert(i,'\\');break;case'/':if(i>start&&i+2<end&&'<'==jsonish.charat(i-1)&&'s'==(jsonish.charat(i+1)|32)&&'c'==(jsonish.charat(i+2)|32))insert(i,'\\');break;case']':if(i+2<end&&']'==jsonish.charat(i+1)&&'>'==jsonish.charat(i+2))replace(i,i+1,"\\u005d");break;case'\\':if(i+1==end)elide(i,i+1);break;charsch=jsonish.charat(i+1);switch(sch)case'b':case'f':case'n':case'r':case't':case'\\':case'/':case'"':++i;break;case'v':replace(i,i+2,"\\u0008");++i;break;case'x':if(i+4<end&&ishexat(i+2)&&ishexat(i+3))replace(i,i+2,"\\u00");i+=3;break;elide(i,i+1);break;case'u':if(i+6<end&&ishexat(i+2)&&ishexat(i+3)&&ishexat(i+4)&&ishexat(i+5))i+=5;break;elide(i,i+1);break;case'0':case'1':case'2':case'3':case'4':case'5':case'6':case'7':intoctalend=i+1;if(octalend+1<end&&isoctat(octalend+1))++octalend;if(ch<='3'&&octalend+1<end&&isoctat(octalend+1))++octalend;intvalue=0;for(intj=i;j<octalend;++j)value=(value<<3)|(jsonish.charat(j)-'0');replace(i+1,octalend,"u00");appendhex(value,2);i=octalend-1;break;default:elide(i,i+1);break;break;default:if(ch<0x20)if(ch==9||ch==0xa||ch==0xd)continue;elseif(ch<0xd800)continue;elseif(ch<0xe000)if(character.ishighsurrogate(ch)&&i+1<end&&character.islowsurrogate(jsonish.charat(i+1)))++i;continue;elseif(ch<=0xfffd)continue;replace(i,i+1,"\\u");for(intj=4;--j>=0;)sanitizedjson.append(hex_digits[(ch>>>(j<<2))&0xf]);break;if(!closed)insert(end,'"');