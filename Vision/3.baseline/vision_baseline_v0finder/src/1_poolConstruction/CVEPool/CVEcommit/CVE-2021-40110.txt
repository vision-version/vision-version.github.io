PACK:./clones/apache__split__james-project
commit 90ec73f3138e272896d110575eeb063f6eef1d9c
Author: Benoit Tellier <btellier@linagora.com>
Date:   Sun Aug 22 20:40:53 2021 +0700

    JAMES-3635 Upgrade PrefixedRegex to RE2J
    
    https://github.com/google/re2j

diff --git a/mailbox/api/pom.xml b/mailbox/api/pom.xml
index 8b34b843cb..7383fa6ec3 100644
--- a/mailbox/api/pom.xml
+++ b/mailbox/api/pom.xml
@@ -71,6 +71,11 @@
             <groupId>com.google.guava</groupId>
             <artifactId>guava</artifactId>
         </dependency>
+        <dependency>
+            <groupId>com.google.re2j</groupId>
+            <artifactId>re2j</artifactId>
+            <version>1.6</version>
+        </dependency>
         <dependency>
             <groupId>com.ibm.icu</groupId>
             <artifactId>icu4j</artifactId>
diff --git a/mailbox/api/src/main/java/org/apache/james/mailbox/model/search/PrefixedRegex.java b/mailbox/api/src/main/java/org/apache/james/mailbox/model/search/PrefixedRegex.java
index 3f2be46611..1040391c35 100644
--- a/mailbox/api/src/main/java/org/apache/james/mailbox/model/search/PrefixedRegex.java
+++ b/mailbox/api/src/main/java/org/apache/james/mailbox/model/search/PrefixedRegex.java
@@ -22,7 +22,8 @@ package org.apache.james.mailbox.model.search;
 import java.util.Objects;
 import java.util.Optional;
 import java.util.StringTokenizer;
-import java.util.regex.Pattern;
+
+import com.google.re2j.Pattern;
 
 public class PrefixedRegex implements MailboxNameExpression {
 
diff --git a/mailbox/api/src/test/java/org/apache/james/mailbox/model/search/PrefixedRegexTest.java b/mailbox/api/src/test/java/org/apache/james/mailbox/model/search/PrefixedRegexTest.java
index 517eb722e7..95a2681c58 100644
--- a/mailbox/api/src/test/java/org/apache/james/mailbox/model/search/PrefixedRegexTest.java
+++ b/mailbox/api/src/test/java/org/apache/james/mailbox/model/search/PrefixedRegexTest.java
@@ -21,8 +21,14 @@ package org.apache.james.mailbox.model.search;
 
 import static org.assertj.core.api.Assertions.assertThat;
 
+import java.util.concurrent.ExecutorService;
+import java.util.concurrent.Executors;
+import java.util.concurrent.TimeUnit;
+
 import org.junit.jupiter.api.Test;
 
+import com.google.re2j.Pattern;
+
 import nl.jqno.equalsverifier.EqualsVerifier;
 
 class PrefixedRegexTest {
@@ -34,9 +40,25 @@ class PrefixedRegexTest {
     public void shouldMatchBeanContract() {
         EqualsVerifier.forClass(PrefixedRegex.class)
             .withIgnoredFields("pattern")
+            .withPrefabValues(Pattern.class, Pattern.compile("a"), Pattern.compile("b"))
             .verify();
     }
 
+    @Test
+    void slowRegexShouldNotBeConstructedByFuzzing() throws Exception {
+        ExecutorService executorService = Executors.newSingleThreadExecutor();
+
+        try {
+            executorService.submit(() -> {
+                PrefixedRegex prefixedRegex = new PrefixedRegex("", "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%a", PATH_DELIMITER);
+
+                prefixedRegex.isExpressionMatch("aa%%%%%%%%%%%%%%%%");
+            }).get(30, TimeUnit.SECONDS);
+        } finally {
+            executorService.shutdownNow();
+        }
+    }
+
     @Test
     void isWildShouldReturnTrueWhenOnlyFreeWildcard() {
         PrefixedRegex prefixedRegex = new PrefixedRegex(PREFIX, "*", PATH_DELIMITER);
