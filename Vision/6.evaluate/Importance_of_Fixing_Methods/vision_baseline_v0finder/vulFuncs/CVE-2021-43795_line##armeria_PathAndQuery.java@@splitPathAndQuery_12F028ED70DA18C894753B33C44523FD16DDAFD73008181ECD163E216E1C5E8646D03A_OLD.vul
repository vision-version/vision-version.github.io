finalbytespath;finalbytesquery;if(pathandquery==null)returnroot_path_query;finalintquerypos=pathandquery.indexof('?');if(querypos>=0)if((path=decodepercentsandencodetoutf8(pathandquery,0,querypos,true))==null)returnnull;if((query=decodepercentsandencodetoutf8(pathandquery,querypos+1,pathandquery.length(),false))==null)returnnull;elseif((path=decodepercentsandencodetoutf8(pathandquery,0,pathandquery.length(),true))==null)returnnull;query=null;if(path.data[0]!='/')returnnull;if(pathcontainsdoubledots(path))returnnull;returnnewpathandquery(encodetopercents(path,true),query!=null?encodetopercents(query,false):null);