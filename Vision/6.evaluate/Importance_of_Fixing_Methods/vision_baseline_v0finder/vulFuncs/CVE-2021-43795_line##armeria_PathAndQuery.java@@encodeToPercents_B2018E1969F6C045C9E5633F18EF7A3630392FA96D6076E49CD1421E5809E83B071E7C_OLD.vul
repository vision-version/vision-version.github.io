finalbitsetallowedchars=ispath?allowed_path_chars:allowed_query_chars;finalintlength=value.length;booleanneedsencoding=false;for(inti=0;i<length;i++)if(!allowedchars.get(value.data[i]&0xff))needsencoding=true;break;if(!needsencoding)returnnewstring(value.data,0,0,length);finalstringbuilderbuf=newstringbuilder(length);for(inti=0;i<length;i++)finalintb=value.data[i]&0xff;if(b==percent_encoding_marker&&(i+1)<length)finalintmarker=value.data[i+1]&0xff;finalstringpercentencodedchar=marker_to_percent_encoded_char[marker];if(percentencodedchar!=null)buf.append(percentencodedchar);i++;continue;if(allowedchars.get(b))buf.append((char)b);elseif(b=='')if(ispath)buf.append("%20");elsebuf.append('+');elsebuf.append('%');appendhexnibble(buf,b>>>4);appendhexnibble(buf,b&0xf);returnbuf.tostring();