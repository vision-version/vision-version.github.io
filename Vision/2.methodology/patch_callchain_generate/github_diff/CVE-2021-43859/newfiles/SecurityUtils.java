package com.thoughtworks.xstream.core;
import com.thoughtworks.xstream.XStream;
import com.thoughtworks.xstream.converters.ConversionException;
import com.thoughtworks.xstream.converters.UnmarshallingContext;
import com.thoughtworks.xstream.security.InputManipulationException;
public class SecurityUtils {
    public static void checkForCollectionDoSAttack(final UnmarshallingContext context, final long start) {
        final int diff = (int)((System.currentTimeMillis() - start) / 1000);
        if (diff > 0) {
            final Integer secondsUsed = (Integer)context.get(XStream.COLLECTION_UPDATE_SECONDS);
            if (secondsUsed != null) {
                final Integer limit = (Integer)context.get(XStream.COLLECTION_UPDATE_LIMIT);
                if (limit == null) {
                    throw new ConversionException("Missing limit for updating collections.");
                }
                
                final int seconds = secondsUsed.intValue() + diff;
                if (seconds > limit.intValue()) {
                    throw new InputManipulationException( "Denial of Service attack assumed. Adding elements to collections or maps exceeds " + limit.intValue() + " seconds.");
                }
                
                context.put(XStream.COLLECTION_UPDATE_SECONDS, new Integer(seconds));
            }
            
        }
        
    }
    
}

